# i18n Subsystem

This app uses i18next + react-i18next with a main-managed, persisted locale and renderer-side translation. The design is extensible: adding a language only requires updating a single source of truth and providing resources.

## Goals
- Single source of truth for supported locales and metadata
- Locale is an application-wide state owned by the main process
- Persist locale across sessions (JSON store under userData)
- Secure IPC bridge for get/set locale
- Renderer initializes i18n before rendering; reacts to runtime locale changes
- Platform + locale-aware font stacks

## Key Files
- `src/main/shared/locales.ts`
  - `SUPPORTED_LOCALES`: array of `{ code, label, nativeLabel }`
  - `LocaleCode`, `DEFAULT_LOCALE_CODE`
  - `normalizeToSupportedLocale(input)`
  - `getLocaleCssClass(code)`, `getAllLocaleCssClasses()`

- `src/main/store/app-config.ts`
  - JSON store for app configuration:
    - `locale: LocaleCode`
    - `dbUrl: string`
  - Stored at `path.join(app.getPath('userData'), 'app-config.json')`

- `src/main/index.ts`
  - Reads persisted `locale` on startup and normalizes it
  - Builds localized Application Menu using current locale (labels loaded from shared JSON)
  - Builds “Language” menu from `SUPPORTED_LOCALES` (radio group) and reflects checked state
  - Broadcasts locale to all renderers (`webContents.send('app:set-locale', code)`)
  - IPC:
    - `ipcMain.handle('app:get-locale') -> LocaleCode`
    - `ipcMain.on('app:set-locale', code: LocaleCode)` persists and broadcasts

- Consolidated menu labels from JSON locale files:
  - Main loads `src/main/shared/i18n/locales/<code>/menu.json` at runtime via `import.meta.glob` (en-US fallback)
  - Loader lives in `src/main/i18n/menu-loader.ts` (main-only, no imports from renderer/preload)

- `src/preload/index.ts` + `src/preload/index.d.ts`
  - `window.electronApi.getLocale(): Promise<LocaleCode>`
  - `window.electronApi.setLocale(code: LocaleCode): void`
  - `window.electronApi.onSetLocale(handler: (code: LocaleCode) => void): void`

- `src/renderer/src/i18n/index.ts`
  - `initI18n()` — awaits preload `getLocale()`; falls back to system locale via `normalizeToSupportedLocale`
  - Initializes i18next with resources and sets `<html lang>` and locale CSS class via helpers

- `src/renderer/src/i18n/resources.ts`
  - Lazy-loaded resources per namespace (e.g., `common`) and locale from shared JSON via `import.meta.glob`
  - Single source of truth: reads from `src/main/shared/i18n/locales/<code>/common.json`

- `src/renderer/src/i18n/types.d.ts`
  - i18next module augmentation for typed `t()` keys under default namespace

- `src/renderer/index.tsx`
  - Awaits `initI18n()` before rendering
  - Listens to `app:set-locale` and calls `i18n.changeLanguage()`
  - Applies `<html lang>` and locale CSS classes using shared helpers

- `src/renderer/globals.css`
  - Platform (`platform-darwin`, `platform-other`) + locale (`locale-*`) specific font stacks

## Runtime Flow
1) Main process
- On ready: read `app-config.json` → `locale`; normalize; update menu radio checked state; broadcast `app:set-locale` to all renderers
- Register IPC:
  - `app:get-locale` → return current persisted locale
  - `app:set-locale` → persist + update menu + broadcast
  - On locale change, rebuild the Application Menu with localized labels, then update the checked radio state
 - Normalization: `normalizeToSupportedLocale(input)` selects an exact match if available, then falls back to a base language match (e.g., `en-*` → `en-US` if supported), otherwise the default locale

2) Renderer bootstrap
- `initI18n()` fetches locale via `getLocale()` and initializes i18next
- Lazy-loads the default namespace bundle for the active locale
- Sets `<html lang>` and `locale-*` class
- Subscribes to `onSetLocale` for runtime switching
 - Type safety: runtime guard in preload validates `getLocale()` result; renderer uses `normalizeToSupportedLocale` and typed `LocaleCode` (no `as never` casts)

3) Language switching
- Application Menu → Language: items generated from `SUPPORTED_LOCALES`
- Selecting a language persists it, rebuilds the menu with localized labels, and updates all windows
- Components render automatically using `useTranslation()`

## Using Translations
```tsx
import { useTranslation } from 'react-i18next'

export function Example(): React.JSX.Element {
  const { t } = useTranslation('common')
  return <div>{t('app.title')}</div>
}
```

## Adding a New Language
1) Add metadata
- `src/main/shared/locales.ts`: append to `SUPPORTED_LOCALES` with your `{ code, label, nativeLabel }`

2) Add resources
- Add JSON under `src/main/shared/i18n/locales/<code>/`:
  - `common.json` (renderer UI strings)
  - `menu.json` (Application Menu labels)

3) (Optional) Fonts
- Update `globals.css` for locale-specific font stacks using `.platform-*/.locale-*` selectors

4) Done
- Menu and IPC adapt automatically; persistence uses the same unified store

## IPC API (Preload)
- `getLocale(): Promise<LocaleCode>` — read current persisted locale
- `setLocale(code: LocaleCode): void` — request locale change application-wide
- `onSetLocale(handler)` — subscribe to locale-change broadcasts

## Persistence Schema (`app-config.json`)
```json
{
  "locale": "en-US",
  "dbUrl": "postgres://postgres:postgres@localhost:5432"
}
```

## Testing
- Verify initial locale:
  - Delete or edit `app-config.json`, restart app, and confirm menu checked state and UI language
- Switch from menu:
  - Change language and verify all windows update
- Programmatic switch (DevTools):
  - `window.electronApi.setLocale('zh-CN')`
- Ensure `<html lang>` and `locale-*` class update accordingly (affects font stacks)

 
